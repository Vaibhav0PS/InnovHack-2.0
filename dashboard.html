<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced YOLOv11 Video Analytics Dashboard</title>
    <!-- Bootstrap CSS for layout -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        #video-container {
            position: relative;
            width: 100%;
            max-width: 1280px; /* Adjust based on your video resolution */
            margin: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            background-color: #000;
        }
        #video-feed {
            width: 100%;
            height: auto;
            display: block;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        .stats-card {
            text-align: center;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background-color: white;
        }
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
        .stats-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .alert-item {
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 3px;
        }
        .alert-high { background-color: #f8d7da; border-left: 5px solid #dc3545; }
        .alert-warning { background-color: #fff3cd; border-left: 5px solid #ffc107; }
        .alert-info { background-color: #d1ecf1; border-left: 5px solid #17a2b8; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="mb-4">Advanced YOLOv11 Video Analytics Dashboard</h1>

        <!-- Video Feed Row -->
        <div class="row mb-4">
            <div class="col-12">
                <div id="video-container">
                    <img id="video-feed" src="{{ url_for('video_feed') }}" alt="Video Feed">
                </div>
            </div>
        </div>

        <!-- Stats and Alerts Row -->
        <div class="row mb-4">
            <!-- Stats Cards -->
            <div class="col-md-6 col-lg-3">
                <div class="stats-card">
                    <div class="stats-number" id="total-objects">0</div>
                    <div class="stats-label">Total Objects</div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="stats-card">
                    <div class="stats-number" id="active-tracks">0</div>
                    <div class="stats-label">Active Tracks</div>
                </div>
            </div>
             <div class="col-md-6 col-lg-3">
                <div class="stats-card">
                    <div class="stats-number" id="device-info">CPU</div>
                    <div class="stats-label">Processing Device</div>
                </div>
            </div>
             <div class="col-md-6 col-lg-3">
                <div class="stats-card">
                    <div class="stats-number" id="model-info">YOLOv11</div>
                    <div class="stats-label">Model</div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <!-- Alerts -->
            <div class="col-md-12 col-lg-4">
                <h4>Recent Alerts</h4>
                <div id="alerts-container" style="max-height: 300px; overflow-y: auto; background-color: white; padding: 10px; border-radius: 5px;">
                     <p class="text-muted">No alerts yet.</p>
                </div>
            </div>

            <!-- Current Detections -->
            <div class="col-md-12 col-lg-4">
                <h4>Current Detections</h4>
                <div id="current-detections" class="d-flex flex-wrap">
                    <p class="text-muted">No objects detected.</p>
                </div>
            </div>

             <!-- Detection Zones -->
            <div class="col-md-12 col-lg-4">
                <h4>Detection Zones</h4>
                <ul id="zones-list" class="list-group">
                    <li class="list-group-item text-muted">No zones configured.</li>
                </ul>
            </div>
        </div>

        <!-- Graphs Row -->
        <div class="row">
            <div class="col-12">
                <h4>Object Detection Over Time</h4>
                <div class="chart-container">
                    <canvas id="analytics-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Chart.js Initialization ---
        const ctx = document.getElementById('analytics-chart').getContext('2d');
        let analyticsChart;

        function initializeChart(labels, datasets) {
            if (analyticsChart) {
                analyticsChart.destroy(); // Destroy existing chart if any
            }
            analyticsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    // labels will be timestamps
                    datasets: datasets.map((data, index) => ({
                        label: labels[index],
                        data: data,
                        borderColor: getRandomColor(), // Function to get random color
                        backgroundColor: 'rgba(0, 0, 0, 0)', // Transparent fill
                        tension: 0.1, // Smooth lines
                        pointRadius: 3
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'second',
                                tooltipFormat: 'MMM d, yyyy HH:mm:ss'
                            },
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                             beginAtZero: true,
                             title: {
                                display: true,
                                text: 'Count'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    animation: {
                        duration: 0 // Disable animation for smoother real-time updates
                    }
                }
            });
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // --- Data Fetching and Updating ---
        const API_BASE = '/'; // Base URL for API endpoints

        // Fetch and update analytics data (counts, graph)
        async function fetchAnalytics() {
            try {
                const response = await fetch(`${API_BASE}analytics`);
                const data = await response.json();

                // Update stats cards
                document.getElementById('total-objects').textContent = data.total_objects || 0;
                document.getElementById('active-tracks').textContent = data.active_tracks || 0;
                document.getElementById('device-info').textContent = data.device || 'Unknown';
                document.getElementById('model-info').textContent = data.model_type || 'Unknown';

                 // Update current detections
                const detectionsContainer = document.getElementById('current-detections');
                detectionsContainer.innerHTML = ''; // Clear previous
                if (data.current_detections && Object.keys(data.current_detections).length > 0) {
                    for (const [label, count] of Object.entries(data.current_detections)) {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-primary me-2 mb-2';
                        badge.textContent = `${label}: ${count}`;
                        detectionsContainer.appendChild(badge);
                    }
                } else {
                     detectionsContainer.innerHTML = '<p class="text-muted">No objects detected.</p>';
                }

                // Update zones list
                 const zonesContainer = document.getElementById('zones-list');
                 zonesContainer.innerHTML = ''; // Clear previous
                 if (data.zones && data.zones.length > 0) {
                      data.zones.forEach(zone => {
                          const li = document.createElement('li');
                          li.className = `list-group-item ${zone.active ? 'list-group-item-success' : 'list-group-item-secondary'}`;
                          li.textContent = `${zone.name} (${zone.active ? 'Active' : 'Inactive'})`;
                          zonesContainer.appendChild(li);
                      });
                 } else {
                      zonesContainer.innerHTML = '<li class="list-group-item text-muted">No zones configured.</li>';
                 }


                // Prepare data for Chart.js
                if (data.time_series) {
                    const labels = Object.keys(data.time_series);
                    const datasets = labels.map(label => {
                         // Chart.js expects {x: timestamp, y: value} objects
                         return data.time_series[label].map(point => ({
                             x: new Date(point.time), // Parse ISO string
                             y: point.count
                         }));
                    });

                    // Only initialize/update chart if we have data
                    if (labels.length > 0 && datasets.some(ds => ds.length > 0)) {
                        initializeChart(labels, datasets);
                    }
                }


            } catch (error) {
                console.error("Error fetching analytics:", error);
            }
        }

        // Fetch and update alerts
        async function fetchAlerts() {
            try {
                const response = await fetch(`${API_BASE}alerts`);
                const alerts = await response.json();
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = ''; // Clear previous

                if (alerts && alerts.length > 0) {
                    // Sort alerts by timestamp (newest first)
                    alerts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    alerts.forEach(alert => {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = `alert-item alert-${alert.severity || 'info'}`;
                        const alertTime = new Date(alert.timestamp).toLocaleTimeString();
                        alertDiv.innerHTML = `
                            <strong>[${alert.type}]</strong> ${alert.message}
                            <br><small class="text-muted">${alertTime}</small>
                        `;
                        alertsContainer.appendChild(alertDiv);
                    });
                } else {
                    alertsContainer.innerHTML = '<p class="text-muted">No alerts yet.</p>';
                }
            } catch (error) {
                console.error("Error fetching alerts:", error);
                document.getElementById('alerts-container').innerHTML = '<p class="text-danger">Error loading alerts.</p>';
            }
        }

        // --- Initial Load and Periodic Updates ---
        document.addEventListener('DOMContentLoaded', () => {
            // Fetch data immediately
            fetchAnalytics();
            fetchAlerts();

            // Set up periodic updates (e.g., every 2 seconds)
            setInterval(fetchAnalytics, 2000);
            setInterval(fetchAlerts, 5000); // Alerts can update less frequently
        });

    </script>
</body>
</html>